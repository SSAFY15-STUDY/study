name: PR Notification

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  # 1. ê³µí†µ ë°ì´í„° ê°€ê³µ (Single Source of Truth)
  prepare:
    runs-on: ubuntu-latest
    outputs:
      action_type: ${{ steps.set_info.outputs.action_type }}
      pr_title: ${{ github.event.pull_request.title }}
      pr_url: ${{ github.event.pull_request.html_url }}
      author: ${{ github.event.pull_request.user.login }}
    steps:
      - id: set_info
        run: |
          if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            echo "action_type=ğŸ PR ë¨¸ì§€ ì™„ë£Œ" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.action }}" = "opened" ]; then
            echo "action_type=ğŸš€ ìƒˆë¡œìš´ PR ìƒì„±" >> $GITHUB_OUTPUT
          else
            echo "action_type=â™»ï¸ PR ìˆ˜ì •ë³¸ ì—…ë°ì´íŠ¸" >> $GITHUB_OUTPUT
          fi

  # 2. Mattermost ì•Œë¦¼ (ê°€ê³µëœ ë°ì´í„° ì‚¬ìš©)
  notify-mattermost:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Send Mattermost Message
        run: |
          curl -X POST -H 'Content-Type: application/json' \
          -d "{
            \"username\": \"GitHub Bot\",
            \"text\": \"### ${{ needs.prepare.outputs.action_type }}\n- **ì œëª©**: ${{ needs.prepare.outputs.pr_title }}\n- **ì‘ì„±ì**: @${{ needs.prepare.outputs.author }}\n- **ë§í¬**: [GitHubì—ì„œ í™•ì¸í•˜ê¸°](${{ needs.prepare.outputs.pr_url }})\"
          }" \
          ${{ secrets.MATTERMOST_WEBHOOK_URL }}

  # 3. Slack ì•Œë¦¼ (ê°€ê³µëœ ë°ì´í„° ì‚¬ìš©)
  notify-slack:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Message
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"*${{ needs.prepare.outputs.action_type }}*\n> *ì œëª©:* ${{ needs.prepare.outputs.pr_title }}\n> *ì‘ì„±ì:* ${{ needs.prepare.outputs.author }}\n> *ë§í¬:* <${{ needs.prepare.outputs.pr_url }}|ë°”ë¡œê°€ê¸°>\"
          }" \
          ${{ secrets.SLACK_WEBHOOK_URL }}